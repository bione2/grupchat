<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Study Hub</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='chat.css') }}">
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>

<div class="chat-container">
    <div class="chat-header">Study Hub Group</div>
    <div class="chat-box" id="chat-box"></div>

    <div class="chat-input">
        <button class="upload-btn" onclick="document.getElementById('imageInput').click()">ðŸ“·</button>
        <input type="file" id="imageInput" accept="image/*" hidden>
        <input id="msg" placeholder="Ketik pesan... (@bot jadwal hari ini)">
        <button onclick="sendMessage()">âž¤</button>
    </div>
</div>

<script>
const username = prompt("Masukkan nama kamu:") || "Guest";
const socket = io();

/* ================== KIRIM PESAN TEKS ================== */
function sendMessage() {
    const input = document.getElementById("msg");
    const text = input.value.trim();
    if (!text) return;

    addMessage(username, text, true);

    // BOT DUMMY
    if (text.toLowerCase().includes("@bot")) {
        setTimeout(() => {
            addMessage("ðŸ¤– Study Hub Bot", "Jadwal hari ini: Belajar HTML, CSS & JavaScript ðŸ“š", false, true);
        }, 500);
    }

    socket.emit("send_message", {username, message: text});
    input.value = "";
}

/* ================== TERIMA PESAN TEKS ================== */
socket.on("receive_message", data => {
    if (data.username !== username) {
        addMessage(data.username, data.message, false);
    }
});

/* ================== KIRIM GAMBAR ================== */
const imageInput = document.getElementById("imageInput");

imageInput.addEventListener("change", () => {
    const file = imageInput.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
        addImage(username, reader.result, true);
        socket.emit("send_image", {username, image: reader.result});
    };
    reader.readAsDataURL(file);
    imageInput.value = "";
});

/* ================== TERIMA GAMBAR ================== */
socket.on("receive_image", data => {
    if (data.username !== username) {
        addImage(data.username, data.image, false);
    }
});

/* ================== TAMBAH PESAN/FOTO KE CHAT ================== */
function addMessage(name, text, isMe, isBot=false) {
    const box = document.getElementById("chat-box");

    const msgDiv = document.createElement("div");
    msgDiv.className = "message" + (isMe ? " me" : "");

    if (!isMe) {
        const avatar = document.createElement("div");
        avatar.className = "avatar" + (isBot ? " bot" : "");
        avatar.textContent = name[0];
        msgDiv.appendChild(avatar);
    }

    const bubbleWrap = document.createElement("div");
    const nameDiv = document.createElement("div");
    nameDiv.className = "name";
    nameDiv.textContent = name;

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.textContent = text;

    bubbleWrap.appendChild(nameDiv);
    bubbleWrap.appendChild(bubble);
    msgDiv.appendChild(bubbleWrap);
    box.appendChild(msgDiv);
    box.scrollTop = box.scrollHeight;
}

function addImage(name, imgSrc, isMe) {
    const box = document.getElementById("chat-box");

    const msgDiv = document.createElement("div");
    msgDiv.className = "message" + (isMe ? " me" : "");

    if (!isMe) {
        const avatar = document.createElement("div");
        avatar.className = "avatar";
        avatar.textContent = name[0];
        msgDiv.appendChild(avatar);
    }

    const bubbleWrap = document.createElement("div");
    const nameDiv = document.createElement("div");
    nameDiv.className = "name";
    nameDiv.textContent = name;

    const bubble = document.createElement("div");
    bubble.className = "bubble image";
    bubble.innerHTML = `<img src="${imgSrc}"><br><a href="${imgSrc}" download>â¬‡ Download</a>`;

    bubbleWrap.appendChild(nameDiv);
    bubbleWrap.appendChild(bubble);
    msgDiv.appendChild(bubbleWrap);
    box.appendChild(msgDiv);
    box.scrollTop = box.scrollHeight;
}
</script>

</body>
</html>
